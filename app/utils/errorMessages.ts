export type ErrorMapper = (payload?: Record<string, unknown>) => string

// Persian default messages for known API error codes. Can be enhanced with i18n later.
export const errorMessages: Record<string, ErrorMapper> = {
  // ═══════════════════════════════════════════════════════════════
  // دسته ۱: خطاهای اعتبارسنجی ورودی (Input Validation)
  // ═══════════════════════════════════════════════════════════════
  VALIDATION_ERROR: (d) => {
    if (typeof d?.details === 'string' && d.details.trim().length > 0) {
      return d.details
    }
    return (d?.message as string) || 'اطلاعات وارد شده معتبر نیست.'
  },
  REQUIRED_FIELD: (d) => `فیلد ${d?.fieldName || 'مطلوب'} الزامی است.`,
  INVALID_FORMAT: (d) => `فرمت ${d?.fieldName || 'ورودی'} صحیح نیست.`,
  INVALID_EMAIL: () => 'آدرس ایمیل وارد شده معتبر نیست.',
  INVALID_PHONE: () => 'شماره تلفن وارد شده معتبر نیست.',
  INVALID_PASSWORD: () => 'رمز عبور باید حداقل ۸ کاراکتر و شامل حروف و اعداد باشد.',
  PASSWORD_MISMATCH: () => 'رمز عبور و تکرار آن مطابقت ندارند.',
  INVALID_URL: () => 'آدرس وب‌سایت وارد شده معتبر نیست.',
  INVALID_SKU: () => 'کد محصول (SKU) باید یکتا و معتبر باشد.',
  INVALID_PRICE: () => 'قیمت وارد شده معتبر نیست.',
  INVALID_DATE: () => 'تاریخ وارد شده معتبر نیست.',
  INVALID_NUMBER: () => 'عدد وارد شده معتبر نیست.',
  OUT_OF_RANGE: (d) => `مقدار باید بین ${d?.min || 0} تا ${d?.max || 100} باشد.`,
  TOO_SHORT: (d) => `حداقل ${d?.minLength || 3} کاراکتر وارد کنید.`,
  TOO_LONG: (d) => `حداکثر ${d?.maxLength || 255} کاراکتر مجاز است.`,
  
  // ═══════════════════════════════════════════════════════════════
  // دسته ۲: خطاهای تکراری و یکتایی (Uniqueness/Duplication)
  // ═══════════════════════════════════════════════════════════════
  DUPLICATE_NAME: () => 'نام وارد شده قبلاً استفاده شده است.',
  DUPLICATE_EMAIL: () => 'این ایمیل قبلاً ثبت شده است.',
  DUPLICATE_PHONE: () => 'این شماره تلفن قبلاً ثبت شده است.',
  DUPLICATE_SKU: () => 'این کد محصول (SKU) قبلاً استفاده شده است.',
  DUPLICATE_SLUG: () => 'این نام انگلیسی (slug) قبلاً استفاده شده است.',
  DUPLICATE_CATEGORY: () => 'این دسته‌بندی قبلاً وجود دارد.',
  // نگاشت عمومی برای ارورهای تکراری URL/Slug در دسته‌بندی‌ها
  CATEGORY_SLUG_DUPLICATE: () => 'URL دسته‌بندی تکراری است. لطفاً یک URL یکتا وارد کنید یا اجازه دهید سیستم به‌صورت خودکار آن را یکتا کند.',
  CATEGORY_SLUG_REQUIRED: () => 'URL یا نام رسمی (English) الزامی است. لطفاً یکی را وارد کنید تا URL ساخته شود.',
  DUPLICATE_BRAND: () => 'این برند قبلاً وجود دارد.',
  DUPLICATE_ATTRIBUTE: () => 'این ویژگی قبلاً تعریف شده است.',
  
  // ═══════════════════════════════════════════════════════════════
  // دسته ۳: خطاهای عدم دسترسی (Not Found)
  // ═══════════════════════════════════════════════════════════════
  NOT_FOUND: () => 'موردی یافت نشد.',
  USER_NOT_FOUND: () => 'کاربر یافت نشد.',
  PRODUCT_NOT_FOUND: () => 'محصول یافت نشد.',
  CATEGORY_NOT_FOUND: () => 'دسته‌بندی یافت نشد.',
  BRAND_NOT_FOUND: () => 'برند یافت نشد.',
  ORDER_NOT_FOUND: () => 'سفارش یافت نشد.',
  ATTRIBUTE_NOT_FOUND: () => 'ویژگی یافت نشد.',
  ATTRIBUTE_GROUP_NOT_FOUND: () => 'گروه ویژگی یافت نشد.',
  IMAGE_NOT_FOUND: () => 'تصویر یافت نشد.',
  FILE_NOT_FOUND: () => 'فایل یافت نشد.',
  PAGE_NOT_FOUND: () => 'صفحه یافت نشد.',
  
  // ═══════════════════════════════════════════════════════════════
  // دسته ۴: خطاهای احراز هویت و مجوز (Auth & Authorization)
  // ═══════════════════════════════════════════════════════════════
  UNAUTHORIZED: () => 'برای این عملیات باید وارد شوید.',
  FORBIDDEN: () => 'صفحه مورد نظر پیدا نشد.',
  TOKEN_EXPIRED: () => 'نشست شما منقضی شده است. لطفاً مجدد وارد شوید.',
  TOKEN_INVALID: () => 'توکن احراز هویت نامعتبر است.',
  LOGIN_FAILED: () => 'ایمیل یا رمز عبور اشتباه است.',
  ACCOUNT_LOCKED: () => 'حساب کاربری شما مسدود شده است.',
  ACCOUNT_NOT_VERIFIED: () => 'ابتدا حساب کاربری خود را تایید کنید.',
  PASSWORD_RESET_REQUIRED: () => 'شما باید رمز عبور خود را تغییر دهید.',
  ADMIN_REQUIRED: () => 'فقط مدیران مجاز به انجام این عملیات هستند.',
  SYSTEM_ROLE_DELETE_ERROR: () => 'نقش‌های سیستمی قابل حذف نیستند.',
  SYSTEM_ROLE_UPDATE_ERROR: () => 'نقش‌های سیستمی قابل ویرایش نیستند.',
  
  // ═══════════════════════════════════════════════════════════════
  // دسته ۵: خطاهای کسب‌وکار (Business Logic)
  // ═══════════════════════════════════════════════════════════════
  INSUFFICIENT_STOCK: () => 'موجودی کافی نیست.',
  PRODUCT_NOT_AVAILABLE: () => 'محصول در حال حاضر موجود نیست.',
  CATEGORY_HAS_PRODUCTS: () => 'این دسته‌بندی دارای محصول است و قابل حذف نیست.',
  CATEGORY_HAS_CHILDREN: () => 'این دسته‌بندی دارای زیرشاخه است و قابل حذف نیست.',
  ATTRIBUTE_IN_USE: () => 'این ویژگی در محصولات استفاده شده و قابل حذف نیست.',
  BRAND_HAS_PRODUCTS: () => 'این برند دارای محصول است و قابل حذف نیست.',
  ORDER_ALREADY_PROCESSED: () => 'این سفارش قبلاً پردازش شده است.',
  ORDER_CANNOT_CANCEL: () => 'این سفارش قابل لغو نیست.',
  PAYMENT_FAILED: () => 'پرداخت با شکست مواجه شد.',
  PAYMENT_TIMEOUT: () => 'زمان پرداخت به پایان رسیده است.',
  SHIPPING_NOT_AVAILABLE: () => 'ارسال به این منطقه امکان‌پذیر نیست.',
  DISCOUNT_EXPIRED: () => 'کد تخفیف منقضی شده است.',
  DISCOUNT_NOT_APPLICABLE: () => 'کد تخفیف قابل اعمال نیست.',
  MINIMUM_ORDER_NOT_MET: () => 'حداقل مقدار سفارش رعایت نشده است.',
  MAXIMUM_ORDER_EXCEEDED: () => 'حداکثر مقدار سفارش مجاز تجاوز شده است.',
  
  // ═══════════════════════════════════════════════════════════════
  // دسته ۶: خطاهای فایل و رسانه (File & Media)
  // ═══════════════════════════════════════════════════════════════
  FILE_TOO_LARGE: (d) => `حجم فایل بیش از حد مجاز است. حداکثر ${d?.maxSize || '2MB'} مجاز است.`,
  INVALID_FILE_TYPE: () => 'نوع فایل مجاز نیست.',
  UPLOAD_FAILED: () => 'آپلود فایل با خطا مواجه شد.',
  IMAGE_PROCESSING_FAILED: () => 'پردازش تصویر با خطا مواجه شد.',
  FILE_CORRUPTED: () => 'فایل خراب است یا قابل خواندن نیست.',
  STORAGE_FULL: () => 'فضای ذخیره‌سازی تمام شده است.',
  
  // ═══════════════════════════════════════════════════════════════
  // دسته ۷: خطاهای شبکه و ارتباط (Network & Communication)
  // ═══════════════════════════════════════════════════════════════
  NETWORK_ERROR: () => 'خطا در ارتباط با سرور. اتصال اینترنت خود را بررسی کنید.',
  TIMEOUT: () => 'زمان انتظار به پایان رسید. لطفاً مجدد تلاش کنید.',
  CONNECTION_REFUSED: () => 'امکان برقراری ارتباط با سرور وجود ندارد.',
  DNS_ERROR: () => 'خطا در تبدیل نام دامنه.',
  SSL_ERROR: () => 'خطا در برقراری ارتباط امن.',
  
  // ═══════════════════════════════════════════════════════════════
  // دسته ۸: خطاهای دیتابیس (Database)
  // ═══════════════════════════════════════════════════════════════
  DB_ERROR: () => 'خطا در ارتباط با دیتابیس. لطفاً بعداً تلاش کنید.',
  DB_CONNECTION_FAILED: () => 'امکان اتصال به دیتابیس وجود ندارد.',
  DB_CONSTRAINT_VIOLATION: () => 'نقض محدودیت‌های دیتابیس.',
  DB_TRANSACTION_FAILED: () => 'تراکنش دیتابیس با شکست مواجه شد.',
  DB_QUERY_TIMEOUT: () => 'زمان انتظار درخواست دیتابیس به پایان رسید.',
  
  // ═══════════════════════════════════════════════════════════════
  // دسته ۹: خطاهای سیستمی و سرور (System & Server)
  // ═══════════════════════════════════════════════════════════════
  INTERNAL_ERROR: () => 'خطای داخلی سرور. لطفاً بعداً تلاش کنید.',
  SERVICE_UNAVAILABLE: () => 'سرویس در حال حاضر در دسترس نیست.',
  MAINTENANCE_MODE: () => 'سایت در حال تعمیر و نگهداری است.',
  RATE_LIMIT_EXCEEDED: () => 'تعداد درخواست‌های شما بیش از حد مجاز است. لطفاً کمی صبر کنید.',
  QUOTA_EXCEEDED: () => 'سهمیه استفاده شما تمام شده است.',
  RESOURCE_EXHAUSTED: () => 'منابع سرور در حال حاضر تمام شده است.',
  
  // ═══════════════════════════════════════════════════════════════
  // دسته ۱۰: خطاهای پیکربندی (Configuration)
  // ═══════════════════════════════════════════════════════════════
  CONFIG_ERROR: () => 'خطا در پیکربندی سیستم.',
  FEATURE_DISABLED: () => 'این ویژگی غیرفعال است.',
  VERSION_MISMATCH: () => 'نسخه کلاینت با سرور مطابقت ندارد.',
  API_DEPRECATED: () => 'این API منسوخ شده است.',
  
  // ═══════════════════════════════════════════════════════════════
  // دسته ۱۱: خطاهای خاص محصول و فروشگاه (E-commerce Specific)
  // ═══════════════════════════════════════════════════════════════
  CART_EMPTY: () => 'سبد خرید خالی است.',
  CART_ITEM_NOT_FOUND: () => 'آیتم در سبد خرید یافت نشد.',
  WISHLIST_ITEM_EXISTS: () => 'این محصول قبلاً به لیست علاقه‌مندی اضافه شده است.',
  REVIEW_ALREADY_EXISTS: () => 'شما قبلاً نظر خود را برای این محصول ثبت کرده‌اید.',
  INVALID_COUPON: () => 'کد تخفیف نامعتبر است.',
  ATTRIBUTE_VALUE_REQUIRED: (d) => `انتخاب مقدار برای ویژگی «${d?.attributeName || 'مطلوب'}» الزامی است.`,
  VARIANT_NOT_AVAILABLE: () => 'این تنوع محصول موجود نیست.'
}

export function resolveErrorMessage(payload: unknown): string {
  if (!payload) return 'خطا در انجام عملیات'
  const p = payload as Record<string, unknown>
  const code = typeof p.code === 'string' ? p.code : undefined
  const mapper = code && errorMessages[code]
  const message = typeof p.message === 'string' ? p.message : (typeof p.error === 'string' ? p.error : 'خطا در انجام عملیات')
  return mapper ? mapper(p) : message
} 