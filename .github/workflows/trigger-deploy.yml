name: Trigger Deploy

on:
  workflow_run:
    workflows: ["Quality Check", "Security Scan", "CodeQL Advanced", "ESLint", "Semgrep", "DevSkim", "njsscan sarif", "OSV-Scanner", "OSSAR", "Codacy Security Scan"]
    types:
      - completed
    branches:
      - main

# ÿ¨ŸÑŸà⁄Ø€åÿ±€å ÿßÿ≤ ÿßÿ¨ÿ±ÿß€å ŸáŸÖÿ≤ŸÖÿßŸÜ ⁄ÜŸÜÿØ€åŸÜ instance - ŸÅŸÇÿ∑ €å⁄© trigger-deploy ÿØÿ± €å⁄© ÿ≤ŸÖÿßŸÜ
concurrency:
  group: trigger-deploy-main
  cancel-in-progress: false

jobs:
  check-and-deploy:
    name: Check All Workflows and Deploy
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: Check if all workflows succeeded for this commit
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const requiredWorkflows = [
              'Quality Check',
              'Security Scan', 
              'CodeQL Advanced',
              'ESLint',
              'Semgrep',
              'DevSkim',
              'njsscan sarif',
              'OSV-Scanner',
              'OSSAR',
              'Codacy Security Scan'
            ];
            
            // ÿØÿ±€åÿßŸÅÿ™ commit SHA ÿßÿ≤ workflow_run ⁄©Ÿá trigger ÿ¥ÿØŸá
            const commitSha = context.payload.workflow_run.head_sha;
            console.log(`üîç Checking workflows for commit: ${commitSha.substring(0, 7)}`);
            
            // ÿØÿ±€åÿßŸÅÿ™ ÿ™ŸÖÿßŸÖ workflow runs ÿ®ÿ±ÿß€å ÿß€åŸÜ commit
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: 'main',
              per_page: 100
            });
            
            // ŸÅ€åŸÑÿ™ÿ± ⁄©ÿ±ÿØŸÜ workflow Ÿáÿß€å ŸÖÿ±ÿ®Ÿàÿ∑ ÿ®Ÿá ŸáŸÖ€åŸÜ commit
            const commitRuns = {};
            for (const run of runs.workflow_runs) {
              if (requiredWorkflows.includes(run.name) && run.head_sha === commitSha) {
                // ÿß⁄Øÿ± workflow ŸáŸÜŸàÿ≤ ÿØÿ± ÿ≠ÿßŸÑ ÿßÿ¨ÿ±ÿßÿ≥ÿ™ÿå ŸÖŸÜÿ™ÿ∏ÿ± ÿ®ŸÖÿßŸÜ
                if (run.status === 'in_progress' || run.status === 'queued') {
                  console.log(`‚è≥ ${run.name} is still running or queued`);
                  core.setOutput('all_passed', 'false');
                  return false;
                }
                
                // ÿß⁄Øÿ± workflow ÿ®ÿ±ÿß€å ÿß€åŸÜ commit Ÿàÿ¨ŸàÿØ ÿØÿßÿ±ÿØÿå ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸÜ
                if (!commitRuns[run.name] || new Date(run.created_at) > new Date(commitRuns[run.name].created_at)) {
                  commitRuns[run.name] = run;
                }
              }
            }
            
            // ÿ®ÿ±ÿ±ÿ≥€å ÿß€åŸÜ⁄©Ÿá ÿ¢€åÿß ŸáŸÖŸá workflow Ÿáÿß ÿ®ÿ±ÿß€å ÿß€åŸÜ commit Ÿæÿßÿ≥ ÿ¥ÿØŸá‚ÄåÿßŸÜÿØ
            const results = {};
            let allPassed = true;
            let allCompleted = true;
            
            for (const workflow of requiredWorkflows) {
              const run = commitRuns[workflow];
              
              if (!run) {
                // ÿß⁄Øÿ± workflow ÿ®ÿ±ÿß€å ÿß€åŸÜ commit ÿßÿ¨ÿ±ÿß ŸÜÿ¥ÿØŸáÿå ŸÖŸÜÿ™ÿ∏ÿ± ÿ®ŸÖÿßŸÜ
                console.log(`‚è≥ ${workflow}: Not found for this commit`);
                allCompleted = false;
                allPassed = false;
                results[workflow] = '‚è≥';
              } else if (run.status === 'in_progress' || run.status === 'queued') {
                // ÿß⁄Øÿ± workflow ŸáŸÜŸàÿ≤ ÿØÿ± ÿ≠ÿßŸÑ ÿßÿ¨ÿ±ÿßÿ≥ÿ™
                console.log(`‚è≥ ${workflow}: Still running`);
                allCompleted = false;
                allPassed = false;
                results[workflow] = '‚è≥';
              } else if (run.conclusion === 'success') {
                results[workflow] = '‚úÖ';
                console.log(`‚úÖ ${workflow}: Passed`);
              } else {
                results[workflow] = '‚ùå';
                allPassed = false;
                console.log(`‚ùå ${workflow}: ${run.conclusion || 'failed'}`);
              }
            }
            
            core.setOutput('all_passed', allPassed && allCompleted);
            core.setOutput('all_completed', allCompleted);
            
            if (!allCompleted) {
              console.log('‚è≥ Waiting for all workflows to complete for this commit...');
              return false;
            }
            
            if (allPassed) {
              console.log('üéâ All workflows passed for this commit! Ready to deploy.');
            } else {
              console.log('‚ùå Some workflows failed for this commit. Deployment cancelled.');
            }
            
            return allPassed && allCompleted;

      - name: Check if deployment already triggered or in progress
        id: check_deployment
        uses: actions/github-script@v7
        if: steps.check.outputs.all_passed == 'true' && steps.check.outputs.all_completed == 'true'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commitSha = context.payload.workflow_run.head_sha;
            
            // ÿ®ÿ±ÿ±ÿ≥€å ÿß€åŸÜ⁄©Ÿá ÿ¢€åÿß deploy ÿØÿ± ÿ≠ÿßŸÑ ÿßÿ¨ÿ±ÿßÿ≥ÿ™ €åÿß ŸÇÿ®ŸÑÿßŸã ÿßŸÜÿ¨ÿßŸÖ ÿ¥ÿØŸá
            const { data: deployRuns } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              branch: 'main',
              per_page: 10
            });
            
            // ÿ®ÿ±ÿ±ÿ≥€å ÿß€åŸÜ⁄©Ÿá ÿ¢€åÿß deploy ÿØÿ± ÿ≠ÿßŸÑ ÿßÿ¨ÿ±ÿßÿ≥ÿ™ (ÿ®ÿ±ÿß€å Ÿáÿ± commit)
            const deploymentInProgress = deployRuns.workflow_runs.some(run => 
              run.status === 'in_progress' || run.status === 'queued'
            );
            
            // ÿ®ÿ±ÿ±ÿ≥€å ÿß€åŸÜ⁄©Ÿá ÿ¢€åÿß ÿ®ÿ±ÿß€å ŸáŸÖ€åŸÜ commit ŸÇÿ®ŸÑÿßŸã deploy ÿ¥ÿØŸá
            const alreadyDeployedForCommit = deployRuns.workflow_runs.some(run => 
              run.head_sha === commitSha && run.conclusion === 'success'
            );
            
            if (deploymentInProgress) {
              console.log(`‚è∏Ô∏è Another deployment is already in progress. Skipping...`);
              core.setOutput('already_deployed', 'true');
              core.setOutput('reason', 'deployment_in_progress');
              return false;
            }
            
            if (alreadyDeployedForCommit) {
              console.log(`‚è≠Ô∏è Deployment already completed for commit ${commitSha.substring(0, 7)}`);
              core.setOutput('already_deployed', 'true');
              core.setOutput('reason', 'already_deployed');
              return false;
            }
            
            console.log(`‚úÖ No deployment in progress. Ready to deploy commit ${commitSha.substring(0, 7)}`);
            core.setOutput('already_deployed', 'false');
            return true;

      - name: Trigger deployment
        if: steps.check.outputs.all_passed == 'true' && steps.check.outputs.all_completed == 'true' && (steps.check_deployment.outputs.already_deployed != 'true' || steps.check_deployment.outputs.already_deployed == '')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commitSha = context.payload.workflow_run.head_sha;
            console.log(`üöÄ All tests passed! Triggering deployment workflow for commit ${commitSha.substring(0, 7)}...`);
            
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main'
            });
            
            console.log('‚úÖ Deployment triggered successfully!');
