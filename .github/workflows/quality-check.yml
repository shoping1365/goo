name: Quality Check

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  encoding-check:
    name: UTF-8 Encoding Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check file encodings
        run: |
          echo "Checking UTF-8 encoding..."
          # Find text files and check if they are valid UTF-8
          # We check .ts, .tsx, .js, .jsx, .vue, .md, .json
          FAILED_FILES=$(find . -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.vue" -o -name "*.md" -o -name "*.json" \) -not -path "*/node_modules/*" -not -path "*/.nuxt/*" -not -path "*/.output/*" -not -path "*/dist/*" -print0 | xargs -0 -I {} bash -c 'iconv -f UTF-8 -t UTF-8 "{}" > /dev/null 2>&1 || echo "{}"')
          
          if [ -n "$FAILED_FILES" ]; then
            echo "❌ Error: The following files are not valid UTF-8 (potential corrupted Persian characters):"
            echo "$FAILED_FILES"
            exit 1
          else
            echo "✅ All checked files are valid UTF-8"
          fi

  auth-check:
    name: Admin Authentication Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Admin Middleware
        run: |
          echo "Checking for 'admin' middleware in admin pages..."
          # Find all .vue files in app/pages/admin
          # Exclude files that might not need auth if any (adjust as needed, currently checking all)
          # We look for "middleware: 'admin'" or 'middleware: "admin"'
          
          # Using grep -L (files without match)
          # We search for the middleware definition allowing for whitespace
          # Pattern: middleware:[space]*['"]admin['"]
          # Checking .vue, .ts, .js, .tsx, .jsx files in app/pages/admin
          MISSING_AUTH=$(find app/pages/admin -type f \( -name "*.vue" -o -name "*.ts" -o -name "*.js" -o -name "*.tsx" -o -name "*.jsx" \) -print0 | xargs -0 grep -L -E "middleware:[[:space:]]*['\"]admin['\"]")
          
          if [ -n "$MISSING_AUTH" ]; then
            echo "❌ Error: The following admin pages are missing the required authentication middleware:"
            echo "$MISSING_AUTH"
            echo "Please add the following to these files:"
            echo "definePageMeta({"
            echo "  middleware: 'admin'"
            echo "})"
            exit 1
          else
            echo "✅ All admin pages have correct authentication middleware"
          fi

  duplicate-code-detection:
    name: Duplicate Code Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install jscpd
        run: npm install -g jscpd

      - name: Detect duplicate code
        run: |
          jscpd . \
            --ignore "node_modules/**,dist/**,.nuxt/**,.output/**,vendor/**,public/tinymce-assets/**,my-go-backend/**" \
            --threshold 10 \
            --reporters "console" \
            --format "typescript,javascript,vue,go" \
            --min-lines 5 \
            --min-tokens 50
          
          echo "✅ Duplicate code check completed"

  go-tests:
    name: Go Unit Tests & Coverage
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: mydb3
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      GOTOOLCHAIN: go1.25.4
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: password
      DB_NAME: mydb3
      DB_SSLMODE: disable
      JWT_SECRET: test-secret-key
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.4'
          cache-dependency-path: my-go-backend/go.sum

      - name: Pin Go toolchain version
        run: go env -w GOTOOLCHAIN=go1.25.4

      - name: Run Go tests with coverage
        working-directory: ./my-go-backend
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -func=coverage.out | tail -1
          
          # Check coverage threshold (minimum 10%)
          COVERAGE=$(go tool cover -func=coverage.out | tail -1 | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          
          # Use awk for float comparison to avoid bc dependency issues or syntax errors
          if awk "BEGIN {exit !($COVERAGE < 10)}"; then
            echo "❌ Coverage below 10%"
            exit 1
          fi
          echo "✅ Coverage meets requirements (>10%)"

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./my-go-backend/coverage.out
          flags: backend
          fail_ci_if_error: false
        continue-on-error: true  # Coverage upload is optional, don't fail workflow

  frontend-tests:
    name: Frontend Type Check & Tests
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: "--max-old-space-size=8192"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Nuxt Prepare
        run: npx nuxt prepare

      - name: Type check
        run: npm run type-check

      - name: Run frontend tests
        run: npm run test

  bundle-size-check:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"

      - name: Analyze bundle size
        run: |
          echo "Analyzing bundle sizes..."
          if [ -d ".output" ]; then
            find .output -type f -name "*.js" -exec ls -lh {} \; | awk '{print $5, $9}' | sort -h
            
            # Check for large bundles (> 5MB)
            LARGE_FILES=$(find .output -type f -name "*.js" -size +5M)
            if [ -n "$LARGE_FILES" ]; then
              echo "⚠️ Large bundle files detected:"
              echo "$LARGE_FILES"
            else
              echo "✅ No oversized bundles"
            fi
          fi

  dead-code-detection:
    name: Dead Code Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install ts-prune
        run: npm install -g ts-prune

      - name: Detect unused exports
        run: |
          echo "Checking for unused exports..."
          ts-prune --project tsconfig.json --ignore "(test|spec|stories)"
          echo "✅ Dead code check completed"

  secrets-scan:
    name: Git Secrets & Credential Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        if: github.event_name != 'push' || github.event.before != github.event.after
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

  sql-security-check:
    name: SQL Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Search for SQL injection patterns
        run: |
          echo "Checking for potential SQL injection vulnerabilities..."
          
          # Check Go files for unsafe SQL patterns
          if grep -r --include="*.go" -E "(Query|Exec)\s*\(\s*fmt\.(Sprintf|Printf)" my-go-backend/ 2>/dev/null; then
            echo "⚠️ Potential SQL injection risk: string concatenation in SQL queries"
            echo "Use parameterized queries instead"
          else
            echo "✅ No obvious SQL injection patterns found"
          fi

  all-checks-complete:
    name: All Quality Checks Passed
    needs: [encoding-check, duplicate-code-detection, go-tests, frontend-tests, bundle-size-check, dead-code-detection, secrets-scan, sql-security-check]
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## ✅ Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All quality checks have passed successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- UTF-8 Encoding validation" >> $GITHUB_STEP_SUMMARY
          echo "- Duplicate code detection" >> $GITHUB_STEP_SUMMARY
          echo "- Go unit tests & coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend type checking" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle size analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Dead code detection" >> $GITHUB_STEP_SUMMARY
          echo "- Secrets scanning" >> $GITHUB_STEP_SUMMARY
          echo "- SQL security check" >> $GITHUB_STEP_SUMMARY

  trigger-deploy:
    name: Trigger Production Deploy
    needs: all-checks-complete
    if: ${{ success() && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch deploy workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main',
              inputs: {
                commit_sha: context.sha
              }
            })
